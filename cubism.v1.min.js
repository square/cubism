(function(a){function d(a){return a}function e(){}function j(a){return Math.floor(a/1e3)}function k(a){var b=a.indexOf("|"),c=a.substring(0,b),d=c.lastIndexOf(","),e=c.lastIndexOf(",",d-1),f=c.lastIndexOf(",",e-1),g=c.substring(f+1,e)*1e3,h=c.substring(d+1)*1e3;return a.substring(b+1).split(",").slice(1).map(function(a){return+a})}function l(a){return a.getTime()/1e3+"s"}function m(a,b){var c=b,d=JSON.parse(a.response),e=d[0].columns.indexOf(c);return e<0&&(e=d[0].columns.length-1),d[0].points.map(function(a){return a[e]})}function n(a){if(!(a instanceof e))throw new Error("invalid context");this.context=a}function q(a,b){return function(c,d,e,f){a(new Date(+c+b),new Date(+d+b),e,f)}}function r(a,b){n.call(this,a),b=+b;var c=b+"";this.valueOf=function(){return b},this.toString=function(){return c}}function t(a,b){function c(b,c){if(c instanceof n){if(b.context!==c.context)throw new Error("mismatch context")}else c=new r(b.context,c);n.call(this,b.context),this.left=b,this.right=c,this.toString=function(){return b+" "+a+" "+c}}var d=c.prototype=Object.create(n.prototype);return d.valueAt=function(a){return b(this.left.valueAt(a),this.right.valueAt(a))},d.shift=function(a){return new c(this.left.shift(a),this.right.shift(a))},d.on=function(a,b){return arguments.length<2?this.left.on(a):(this.left.on(a,b),this.right.on(a,b),this)},function(a){return new c(this,a)}}function w(a){return a&16777214}function x(a){return(a+1&16777214)-1}function B(a){a.style("position","absolute").style("top",0).style("bottom",0).style("width","1px").style("pointer-events","none")}function C(a){return a+"px"}var b=a.cubism={version:"1.6.0"},c=0;b.option=function(a,c){var d=b.options(a);return d.length?d[0]:c},b.options=function(a,b){var c=location.search.substring(1).split("&"),d=[],e=-1,f=c.length,g;while(++e<f)(g=c[e].split("="))[0]==a&&d.push(decodeURIComponent(g[1]));return d.length||arguments.length<2?d:b},b.context=function(){function r(){p=f/d>=1?f/d:1,n.range([0,d*p]);var c=Date.now();return h=new Date(Math.floor((c-k-l)/b)*b),g=new Date(h-d*b),j=new Date(Math.floor((c-k)/b)*b),i=new Date(j-d*b),n.domain([g,h]),console.log("scale.domain: ",g,h),a}var a=new e,b=1e4,d=1440,f=1440,g,h,i,j,k=5e3,l=5e3,m=d3.dispatch("prepare","beforechange","change","focus"),n=a.scale=d3.time.scale().range([0,d]),o,p,q;return a.xScale=function(){return p},a.start=function(){o&&clearTimeout(o);var c=+j+k-Date.now();return c<l&&(c+=b),o=setTimeout(function e(){j=new Date(Math.floor((Date.now()-k)/b)*b),i=new Date(j-d*b),m.prepare.call(a,i,j),setTimeout(function(){n.domain([g=i,h=j]),m.beforechange.call(a,i,j),m.change.call(a,i,j),m.focus.call(a,q)},l),o=setTimeout(e,b)},c),a},a.stop=function(){return o=clearTimeout(o),a},o=setTimeout(a.start,10),a.step=function(a){return arguments.length?(b=+a,r()):b},a.size=function(a){return arguments.length?(d=+a,r()):d},a.length=function(a){return arguments.length?(f=+a,r()):f},a.serverDelay=function(a){return arguments.length?(k=+a,r()):k},a.clientDelay=function(a){return arguments.length?(l=+a,r()):l},a.focus=function(b){return m.focus.call(a,q=b),a},a.on=function(b,c){return arguments.length<2?m.on(b):(m.on(b,c),c!=null&&(/^prepare(\.|$)/.test(b)&&c.call(a,i,j),/^beforechange(\.|$)/.test(b)&&c.call(a,g,h),/^change(\.|$)/.test(b)&&c.call(a,g,h),/^focus(\.|$)/.test(b)&&c.call(a,q)),a)},d3.select(window).on("keydown.context-"+ ++c,function(){switch(!d3.event.metaKey&&d3.event.keyCode){case 37:q==null&&(q=d-1),q>0&&a.focus(--q);break;case 39:q==null&&(q=d-2),q<d-1&&a.focus(++q);break;default:return}d3.event.preventDefault()}),r()};var f=b.context.prototype=e.prototype;f.constant=function(a){return new r(this,+a)},f.cube=function(a){arguments.length||(a="");var b={},c=this;return b.metric=function(b){return c.metric(function(c,d,e,f){d3.json(a+"/1.0/metric"+"?expression="+encodeURIComponent(b)+"&start="+g(c)+"&stop="+g(d)+"&step="+e,function(a){if(!a)return f(new Error("unable to load data"));f(null,a.map(function(a){return a.value}))})},b+="")},b.toString=function(){return a},b};var g=d3.time.format.iso;f.librato=function(a,c){function f(a){var b=avail_rsts[0],c=avail_rsts[avail_rsts.length];if(a>=c)return c;if(a<=b)return b;var d,e,f;for(f=a;f<=c;f++){d=avail_rsts.indexOf(f);if(d>-1){e=avail_rsts[d];break}}var g;for(f=a;f>=b;f--){d=avail_rsts.indexOf(f);if(d>-1){g=avail_rsts[d];break}}return e-a<a-g?e:g}function g(a,b,c){var d=b-a,e=2419200,g=604800,h=172800,i;return d>e?3600:(i=f(c),d>g&&i<900?900:d>h&&i<60?60:i)}var d={},e=this;auth_string="Basic "+btoa(a+":"+c),avail_rsts=[1,60,900,3600];var j=function(a){function d(b,d,e){var f="compose="+a+"&start_time="+b+"&end_time="+d+"&resolution="+g(b,d,e);return c+"?"+f}function e(a,b,c,d){var e=[];for(i=a;i<=b;i+=c){var f=[];while(d.length&&d[0].measure_time<=i)f.push(d.shift().value);var g;f.length?g=f.reduce(function(a,b){return a+b})/f.length:g=e.length?e[e.length-1]:0,e.push(g)}return e}var c="https://metrics-api.librato.com/v1/metrics";return request={},request.fire=function(a,c,f,g){function i(j){d3.json(j).header("X-Requested-With","XMLHttpRequest").header("Authorization",auth_string).header("Librato-User-Agent","cubism/"+b.version).get(function(b,j){if(!b){if(j.measurements.length===0)return;j.measurements[0].series.forEach(function(a){h.push(a)});var k="query"in j&&"next_time"in j.query;if(k)i(d(j.query.next_time,c,f));else{var l=e(a,c,f,h);g(l)}}})}var h=[];i(d(a,c,f))},request};return d.metric=function(a){return e.metric(function(b,c,d,e){j(a).fire(h(b),h(c),h(d),function(a){e(null,a)})},a+="")},d.toString=function(){return"librato"},d};var h=function(a){return Math.floor(a/1e3)};f.graphite=function(a){arguments.length||(a="");var b={},c=this;return b.metric=function(b){var d="sum",e=c.metric(function(c,e,f,g){var h=b;f!==1e4&&(h="summarize("+h+",'"+(f%36e5?f%6e4?f/1e3+"sec":f/6e4+"min":f/36e5+"hour")+"','"+d+"')"),d3.text(a+"/render?format=raw"+"&target="+encodeURIComponent("alias("+h+",'')")+"&from="+j(c-2*f)+"&until="+j(e-1e3),function(a){if(!a)return g(new Error("unable to load data"));g(null,k(a))})},b+="");return e.summarize=function(a){return d=a,e},e},b.find=function(b,c){d3.json(a+"/metrics/find?format=completer"+"&query="+encodeURIComponent(b),function(a){if(!a)return c(new Error("unable to find metrics"));c(null,a.metrics.map(function(a){return a.path}))})},b.toString=function(){return a},b},f.influxdb=function(a){arguments.length||(a="");var b={},c=this;return b.metric=function(b){return c.metric(function(c,d,e,f){var g="&q=select+sum("+b.column+")+from+"+b.series+"+group+by+time("+e*1e3+"u)+fill(0)"+"+where"+"+time+<+"+l(d)+"+and+time+>+"+l(c),h=a+g;d3.xhr(h,"application/json",function(a,b){if(!b)return f(new Error("unable to load data"));f(null,m(b))})},b)},b.toString=function(){return a},b},f.gangliaWeb=function(a){var b="",c="/ganglia2/";arguments.length&&(a.host&&(b=a.host),a.uriPathPrefix&&(c=a.uriPathPrefix,c[0]!="/"&&(c="/"+c),c[c.length-1]!="/"&&(c+="/")));var d={},e=this;return d.metric=function(a){var d=a.clusterName,f=a.metricName,g=a.hostName,h=a.isReport||!1,i=a.titleGenerator||function(a){return"clusterName:"+d+" metricName:"+f+(g?" hostName:"+g:"")},j=a.onChangeCallback,k=h?"g":"m",l=e.metric(function(a,e,h,i){function j(){return"c="+d+"&"+k+"="+f+(g?"&h="+g:"")+"&cs="+a/1e3+"&ce="+e/1e3+"&step="+h/1e3+"&graphlot=1"}d3.json(b+c+"graph.php?"+j(),function(a){if(!a)return i(new Error("Unable to fetch GangliaWeb data"));i(null,a[0].data)})},i(a));return l.toString=function(){return i(a)},j&&l.on("change",j),l},d.toString=function(){return b+c},d};var o=n.prototype;b.metric=n,o.valueAt=function(){return NaN},o.alias=function(a){return this.toString=function(){return a},this},o.extent=function(){var a=0,b=this.context.size(),c,d=Infinity,e=-Infinity;while(++a<b)c=this.valueAt(a),c<d&&(d=c),c>e&&(e=c);return[d,e]},o.on=function(a,b){return arguments.length<2?null:this},o.shift=function(){return this},o.on=function(){return arguments.length<2?null:this},f.metric=function(a,b){function r(b,c){var d=Math.min(j,Math.round((b-g)/i));if(!d||o)return;o=!0,d=Math.min(j,d+p);var f=new Date(c-d*i);a(f,c,i,function(a,b){o=!1;if(a)return console.warn(a);var d=isFinite(g)?Math.round((f-g)/i):0;for(var h=0,j=b.length;h<j;++h)k[h+d]=b[h];l.change.call(e,g,c)})}function s(a,b){isFinite(g)||(g=a),k.splice(0,Math.max(0,Math.min(j,Math.round((a-g)/i)))),g=a,h=b}var d=this,e=new n(d),f=".metric-"+ ++c,g=-Infinity,h,i=d.step(),j=d.size(),k=[],l=d3.dispatch("change"),m=0,o;return e.valueAt=function(a){return k[a]},e.shift=function(b){return d.metric(q(a,+b))},e.on=function(a,b){return arguments.length?(b==null?l.on(a)!=null&&--m==0&&d.on("prepare"+f,null).on("beforechange"+f,null):l.on(a)==null&&++m==1&&d.on("prepare"+f,r).on("beforechange"+f,s),l.on(a,b),b!=null&&/^change(\.|$)/.test(a)&&b.call(d,g,h),e):l.on(a)},arguments.length>1&&(e.toString=function(){return b}),e};var p=6,s=r.prototype=Object.create(n.prototype);s.valueAt=function(){return+this},s.extent=function(){return[+this,+this]},o.add=t("+",function(a,b){return a+b}),o.subtract=t("-",function(a,b){return a-b}),o.multiply=t("*",function(a,b){return a*b}),o.divide=t("/",function(a,b){return a/b}),f.horizon=function(){function r(r){r.on("mousemove.horizon",function(){a.focus(Math.round(d3.mouse(this)[0]))}).on("mouseout.horizon",function(){a.focus(null)}),r.append("canvas").attr("width",g*b).attr("height",h),r.append("span").attr("class","title").text(l),r.append("span").attr("class","value"),r.each(function(l,r){function E(c,d){z.save();var j=u.extent();D=j.every(isFinite),w!=null&&(j=w);var k=0,l=Math.max(-j[0],j[1]);if(this===a){if(l==B){k=g-p;var m=(c-x)/y;console.log("dx = (start1 - start)/ step",m,c,x,y),console.log("width",g);if(m<g){f.width=g*b;var n=f.getContext("2d");q=g*b,console.log("clear canvas0? left, width",0,q),n.clearRect(0,0,q,h),o=m*b,q=(g-m)*b,console.log("draw old canvas? rLeft, rWidth",o,q),n.drawImage(z.canvas,o,0,q,h,0,0,q,h),q=g*b,z.clearRect(0,0,q,h),z.drawImage(n.canvas,0,0)}}x=c}i.domain([0,B=l]),q=(g-k)*b,o=k*b,z.clearRect(o,0,q,h);var r,s=new Date;console.log(s.getHours()+":"+s.getMinutes()+":"+s.getSeconds());for(var t=0;t<C;++t){z.fillStyle=v[C+t];var A=(t-C+1)*h;i.range([C*h+A,A]),A=i(0);for(var E=k,F=g,G;E<F;++E){G=u.valueAt(E),o=E*b,q=b;if(G<=0){r=!0;continue}if(G===undefined)continue;z.fillRect(o,G=i(G),q,A-G)}}if(r){e==="offset"&&(z.translate(0,h),z.scale(1,-1));for(var t=0;t<C;++t){z.fillStyle=v[C-1-t];var A=(t-C+1)*h;i.range([C*h+A,A]),A=i(0);for(var E=k,F=g,G;E<F;++E){G=u.valueAt(E);if(G>=0)continue;z.fillRect(E*b,i(-G),b,A-i(-G))}}}z.restore()}function F(a){a==null&&(a=g-1);var b=u.valueAt(a);A.datum(b).text(isNaN(b)?null:m)}var s=this,t=++c,u=typeof j=="function"?j.call(s,l,r):j,v=typeof n=="function"?n.call(s,l,r):n,w=typeof k=="function"?k.call(s,l,r):k,x=-Infinity,y=a.step(),z=d3.select(s).select("canvas"),A=d3.select(s).select(".value"),B,C=v.length>>1,D;z.datum({id:t,metric:u}),z=z.node().getContext("2d"),a.on("change.horizon-"+t,E),a.on("focus.horizon-"+t,F),u.on("change.horizon-"+t,function(a,b){E(a,b),F(),D&&u.on("change.horizon-"+t,d)})})}var a=this,b=a.xScale(),e="offset",f=document.createElement("canvas"),g=f.width=a.size(),h=f.height=30,i=d3.scale.linear().interpolate(d3.interpolateRound),j=d,k=null,l=d,m=d3.format(".2s"),n=["#08519c","#3182bd","#6baed6","#bdd7e7","#bae4b3","#74c476","#31a354","#006d2c"],o,q;return r.remove=function(b){function c(b){b.metric.on("change.horizon-"+b.id,null),a.on("change.horizon-"+b.id,null),a.on("focus.horizon-"+b.id,null)}b.on("mousemove.horizon",null).on("mouseout.horizon",null),b.selectAll("canvas").each(c).remove(),b.selectAll(".title,.value").remove()},r.mode=function(a){return arguments.length?(e=a+"",r):e},r.height=function(a){return arguments.length?(f.height=h=+a,r):h},r.metric=function(a){return arguments.length?(j=a,r):j},r.scale=function(a){return arguments.length?(i=a,r):i},r.extent=function(a){return arguments.length?(k=a,r):k},r.title=function(a){return arguments.length?(l=a,r):l},r.format=function(a){return arguments.length?(m=a,r):m},r.colors=function(a){return arguments.length?(n=a,r):n},r},f.comparison=function(){function o(o){o.on("mousemove.comparison",function(){a.focus(Math.round(d3.mouse(this)[0]))}).on("mouseout.comparison",function(){a.focus(null)}),o.append("canvas").attr("width",b).attr("height",e),o.append("span").attr("class","title").text(j),o.append("span").attr("class","value primary"),o.append("span").attr("class","value change"),o.each(function(j,o){function B(c,d){v.save(),v.clearRect(0,0,b,e);var g=r.extent(),h=s.extent(),i=t==null?g:t;f.domain(i).range([e,0]),A=g.concat(h).every(isFinite);var j=c/a.step()&1?x:w;v.fillStyle=m[2];for(var k=0,l=b;k<l;++k){var o=f(r.valueAt(k)),p=f(s.valueAt(k));o<p&&v.fillRect(j(k),o,1,p-o)}v.fillStyle=m[0];for(k=0;k<l;++k){var o=f(r.valueAt(k)),p=f(s.valueAt(k));o>p&&v.fillRect(j(k),p,1,o-p)}v.fillStyle=m[3];for(k=0;k<l;++k){var o=f(r.valueAt(k)),p=f(s.valueAt(k));o<=p&&v.fillRect(j(k),o,1,n)}v.fillStyle=m[1];for(k=0;k<l;++k){var o=f(r.valueAt(k)),p=f(s.valueAt(k));o>p&&v.fillRect(j(k),o-n,1,n)}v.restore()}function C(a){a==null&&(a=b-1);var c=r.valueAt(a),d=s.valueAt(a),e=(c-d)/d;y.datum(c).text(isNaN(c)?null:k),z.datum(e).text(isNaN(e)?null:l).attr("class","value change "+(e>0?"positive":e<0?"negative":""))}function D(a,b){B(a,b),C(),A&&(r.on("change.comparison-"+q,d),s.on("change.comparison-"+q,d))}var p=this,q=++c,r=typeof g=="function"?g.call(p,j,o):g,s=typeof h=="function"?h.call(p,j,o):h,t=typeof i=="function"?i.call(p,j,o):i,u=d3.select(p),v=u.select("canvas"),y=u.select(".value.primary"),z=u.select(".value.change"),A;v.datum({id:q,primary:r,secondary:s}),v=v.node().getContext("2d"),r.on("change.comparison-"+q,D),s.on("change.comparison-"+q,D),a.on("change.comparison-"+q,B),a.on("focus.comparison-"+q,C)})}var a=this,b=a.size(),e=120,f=d3.scale.linear().interpolate(d3.interpolateRound),g=function(a){return a[0]},h=function(a){return a[1]},i=null,j=d,k=u,l=v,m=["#9ecae1","#225b84","#a1d99b","#22723a"],n=1.5;return o.remove=function(b){function c(b){b.primary.on("change.comparison-"+b.id,null),b.secondary.on("change.comparison-"+b.id,null),a.on("change.comparison-"+b.id,null),a.on("focus.comparison-"+b.id,null)}b.on("mousemove.comparison",null).on("mouseout.comparison",null),b.selectAll("canvas").each(c).remove(),b.selectAll(".title,.value").remove()},o.height=function(a){return arguments.length?(e=+a,o):e},o.primary=function(a){return arguments.length?(g=a,o):g},o.secondary=function(a){return arguments.length?(h=a,o):h},o.scale=function(a){return arguments.length?(f=a,o):f},o.extent=function(a){return arguments.length?(i=a,o):i},o.title=function(a){return arguments.length?(j=a,o):j},o.formatPrimary=function(a){return arguments.length?(k=a,o):k},o.formatChange=function(a){return arguments.length?(l=a,o):l},o.colors=function(a){return arguments.length?(m=a,o):m},o.strokeWidth=function(a){return arguments.length?(n=a,o):n},o};var u=d3.format(".2s"),v=d3.format("+.0%");f.axis=function(){function h(f){var i=++c,j,k=Math.floor(a.size()*e),l=f.append("svg").datum({id:i}).attr("width",k).attr("height",Math.max(28,-h.tickSize())).append("g").attr("transform","translate(0,"+(d.orient()==="top"?27:4)+")").call(d);a.on("change.axis-"+i,function(){l.call(d),j||(j=d3.select(l.node().appendChild(l.selectAll("text").node().cloneNode(!0))).style("display","none").text(null))}),a.on("focus.axis-"+i,function(a){if(j)if(a==null)j.style("display","none"),l.selectAll("text").style("fill-opacity",null);else{j.style("display",null).attr("x",a).text(g(b.invert(a)));var c=j.node().getComputedTextLength()+6;l.selectAll("text").style("fill-opacity",function(d){return Math.abs(b(d)-a)<c?0:1})}})}var a=this,b=a.scale,d=d3.svg.axis().scale(b),e=a.xScale(),f=a.step()<6e4?y:a.step()<864e5?z:A,g=f;return h.remove=function(b){function c(b){a.on("change.axis-"+b.id,null),a.on("focus.axis-"+b.id,null)}b.selectAll("svg").each(c).remove()},h.focusFormat=function(a){return arguments.length?(g=a==null?f:a,h):g==f?null:a},d3.rebind(h,d,"orient","ticks","tickSubdivide","tickSize","tickPadding","tickFormat")};var y=d3.time.format("%I:%M:%S %p"),z=d3.time.format("%I:%M %p"),A=d3.time.format("%B %d");f.rule=function(){function e(d){var e=++c,f=d.append("div").datum({id:e}).attr("class","line").call(B);d.each(function(e,f){function j(b,c){var e=[];for(var f=0,g=a.size();f<g;++f)i.valueAt(f)&&e.push(f);var h=d.selectAll(".metric").data(e);h.exit().remove(),h.enter().append("div").attr("class","metric line").call(B),h.style("left",C)}var g=this,h=++c,i=typeof b=="function"?b.call(g,e,f):b;if(!i)return;a.on("change.rule-"+h,j),i.on("change.rule-"+h,j)}),a.on("focus.rule-"+e,function(a){f.datum(a).style("display",a==null?"none":null).style("left",a==null?null:C)})}var a=this,b=d;return e.remove=function(b){function c(b){a.on("focus.rule-"+b.id,null)}b.selectAll(".line").each(c).remove()},e.metric=function(a){return arguments.length?(b=a,e):b},e}})(this);